<template>
  <div class="bg-yellow-300 flex justify-center items-center w-screen h-screen">
    <video
      v-show="streaming"
      class="absolute top-10 left-10 rounded-md border-slate-500 border-4 max-w-xs aspect-video"
      id="video"
    ></video>

    <div
      class="phone overflow-hidden w-[360px] h-[800px] rounded-[20px] bg-white relative"
    >
      <!-- Area -->
      <div class="h-8 mx-4 flex justify-between items-center">
        <div class="text-xs">
          <span> {{ parseTime }}</span>
        </div>
        <div class="">
          <div class="flex items-center justify-between gap-x-2">
            <!-- Network -->
            <NetworkIcon :type="type" />

            <!-- Wifi -->
            <WifiIcon :rtt="rtt" />
            <!-- Battery -->
            <BatteryIcon :level="battery" :charging="charging" />
          </div>
        </div>
      </div>
      <!-- Header -->
      <div class="h-14 bg-yellow-500 px-4 flex items-center justify-between">
        <div class="flex gap-4 items-center">
          <!-- Arrow -->
          <svg
            width="16"
            height="14"
            viewBox="0 0 16 14"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M6.66731 1.42464L1.36401 6.72794L6.66731 12.0312M1.36401 6.72794H14.0919H1.36401Z"
              stroke="#00473E"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <div
            class="w-10 aspect-square rounded-full bg-slate-400 overflow-hidden"
          >
            <img
              class="w-full h-full object-cover"
              src="./assets/profile_pic.JPG"
              alt=""
            />
          </div>
          <span class="text-[#00473E] font-bold">Séréna</span>
        </div>
        <div class="flex items-center gap-4">
          <!-- TEL -->
          <svg
            width="32"
            height="32"
            viewBox="0 0 32 32"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M8.75687 8.46166L9.65032 7.77039C10.4883 7.12271 11.6795 7.2436 12.4336 8.05245L13.9354 9.66401C14.5888 10.3658 14.7487 11.4133 14.3307 12.2529L13.1649 14.5906C13.6429 15.5617 14.3453 16.4331 15.2711 17.2049C16.1567 17.9555 17.1838 18.5207 18.2917 18.8671L20.1706 17.3745C20.8824 16.8099 21.8789 16.7995 22.6408 17.349L24.4185 18.6282C25.3056 19.2673 25.6275 20.4761 25.1725 21.4569L24.6856 22.5078C24.2001 23.5539 23.2088 24.2308 22.0837 24.2827C19.426 24.4072 16.4296 22.996 13.0908 20.0503C9.74705 17.0999 7.90259 14.234 7.55968 11.4557C7.41512 10.2866 7.8699 9.14737 8.75687 8.46166Z"
              fill="#00473E"
              fill-opacity="0.95"
            />
          </svg>
          <!-- Search -->
          <svg
            width="20"
            height="20"
            viewBox="0 0 20 20"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M13.6041 12.4158L18.0875 16.8992C18.2451 17.0569 18.3335 17.2707 18.3335 17.4936C18.3334 17.7166 18.2447 17.9303 18.0871 18.0879C17.9294 18.2455 17.7155 18.334 17.4926 18.3339C17.2697 18.3338 17.0559 18.2452 16.8983 18.0875L12.415 13.6042C11.0747 14.6422 9.38937 15.1307 7.70174 14.9703C6.01412 14.8098 4.451 14.0125 3.33037 12.7405C2.20975 11.4685 1.61579 9.81734 1.66935 8.12295C1.7229 6.42856 2.41993 4.81821 3.61864 3.61949C4.81735 2.42078 6.4277 1.72375 8.12209 1.6702C9.81648 1.61665 11.4676 2.2106 12.7396 3.33123C14.0117 4.45185 14.809 6.01497 14.9694 7.7026C15.1299 9.39022 14.6414 11.0756 13.6033 12.4158H13.6041ZM8.3333 13.3333C9.65938 13.3333 10.9312 12.8065 11.8688 11.8689C12.8065 10.9312 13.3333 9.65941 13.3333 8.33332C13.3333 7.00724 12.8065 5.73547 11.8688 4.79779C10.9312 3.86011 9.65938 3.33332 8.3333 3.33332C7.00722 3.33332 5.73545 3.86011 4.79777 4.79779C3.86009 5.73547 3.3333 7.00724 3.3333 8.33332C3.3333 9.65941 3.86009 10.9312 4.79777 11.8689C5.73545 12.8065 7.00722 13.3333 8.3333 13.3333Z"
              fill="#00473E"
            />
          </svg>
          <!-- Options -->
          <svg
            width="18"
            height="18"
            viewBox="0 0 18 18"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M9.00092 7.02C8.74078 7.02 8.4832 7.07124 8.24286 7.17079C8.00253 7.27034 7.78416 7.41625 7.60021 7.60019C7.41627 7.78414 7.27036 8.00251 7.17081 8.24284C7.07126 8.48318 7.02002 8.74077 7.02002 9.0009C7.02002 9.26104 7.07126 9.51863 7.17081 9.75896C7.27036 9.99929 7.41627 10.2177 7.60021 10.4016C7.78416 10.5856 8.00253 10.7315 8.24286 10.831C8.4832 10.9306 8.74078 10.9818 9.00092 10.9818C9.52629 10.9817 10.0301 10.7729 10.4015 10.4013C10.7729 10.0297 10.9815 9.52582 10.9814 9.00045C10.9813 8.47508 10.7724 7.97128 10.4009 7.59988C10.0293 7.22847 9.52539 7.01988 9.00002 7.02H9.00092ZM9.00092 4.68C9.26094 4.67988 9.51839 4.62855 9.75856 4.52894C9.99874 4.42932 10.217 4.28338 10.4007 4.09944C10.5845 3.91549 10.7303 3.69715 10.8296 3.45688C10.929 3.21661 10.9801 2.95912 10.98 2.6991C10.9799 2.43908 10.9286 2.18164 10.829 1.94146C10.7293 1.70128 10.5834 1.48307 10.3995 1.29929C10.2155 1.11552 9.99717 0.969771 9.7569 0.870375C9.51663 0.77098 9.25914 0.719883 8.99912 0.720001C8.47399 0.72024 7.97046 0.929076 7.59931 1.30057C7.22816 1.67206 7.01978 2.17577 7.02002 2.7009C7.02026 3.22603 7.22909 3.72956 7.60058 4.10071C7.97208 4.47186 8.47579 4.68024 9.00092 4.68ZM9.00092 13.32C8.47555 13.32 7.9717 13.5287 7.60021 13.9002C7.22872 14.2717 7.02002 14.7755 7.02002 15.3009C7.02002 15.8263 7.22872 16.3301 7.60021 16.7016C7.9717 17.0731 8.47555 17.2818 9.00092 17.2818C9.52629 17.2818 10.0301 17.0731 10.4016 16.7016C10.7731 16.3301 10.9818 15.8263 10.9818 15.3009C10.9818 14.7755 10.7731 14.2717 10.4016 13.9002C10.0301 13.5287 9.52629 13.32 9.00092 13.32Z"
              fill="#00473E"
            />
          </svg>
        </div>
      </div>
      <!-- APP -->
      <div
        class="mt-6 mx-4 overflow-y-scroll h-3/4 flex flex-col items-baseline"
        id="msg-list"
      >
        <!-- Date -->
        <div class="w-full text-center text-xs">
          <span>{{ date }}</span>
        </div>
        <!-- Messages -->
        <MessagesList
          :messages="messages"
          :isProcessing="context.isProcessing"
        />
      </div>

      <!-- Footer -->
      <div
        class="absolute bottom-6 h-10 w-full flex justify-between items-center px-3"
      >
        <!-- Plus -->
        <svg
          width="18"
          height="18"
          viewBox="0 0 18 18"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M8.04545 17.2585V0.0142038H9.70739V17.2585H8.04545ZM0.261364 9.47443V7.7983H17.4915V9.47443H0.261364Z"
            fill="#00332C"
          />
        </svg>

        <!-- Input -->
        <div
          class="px-4 py-[10px] rounded-[20px] w-[250px] border-black border flex justify-between items-center"
        >
          <div class="flex gap-x-2 items-center">
            <!-- Smiley -->
            <svg
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M5.13873 2.725C6.09386 2.07541 7.16815 1.62136 8.29963 1.38904C9.43112 1.15672 10.5974 1.15073 11.7312 1.37141C12.865 1.5921 13.9439 2.03509 14.9057 2.67483C15.8674 3.31458 16.693 4.13842 17.3347 5.09882C17.9765 6.05923 18.4217 7.1372 18.6448 8.27055C18.8679 9.40389 18.8643 10.5702 18.6344 11.7022C18.4044 12.8341 17.9526 13.9094 17.305 14.8658C16.6574 15.8223 15.8269 16.6411 14.8612 17.275C12.9318 18.5645 10.5691 19.0346 8.29302 18.5821C6.01691 18.1295 4.01381 16.7913 2.72436 14.8619C1.43491 12.9324 0.964742 10.5698 1.41729 8.29367C1.86984 6.01756 3.20803 4.01445 5.13748 2.725H5.13873ZM5.83373 16.2363C6.65256 16.7895 7.57266 17.1755 8.54114 17.372C9.50963 17.5686 10.5074 17.5718 11.4771 17.3814C12.4468 17.1911 13.3694 16.811 14.1918 16.263C15.0141 15.715 15.7201 15.0099 16.269 14.1882C16.818 13.3664 17.1991 12.4443 17.3906 11.4748C17.582 10.5053 17.58 9.50755 17.3846 8.53884C17.1892 7.57013 16.8043 6.64958 16.252 5.83011C15.6996 5.01064 14.9908 4.3084 14.1662 3.76375C12.5122 2.67122 10.4928 2.27796 8.54967 2.66994C6.6065 3.06191 4.89754 4.20723 3.79635 5.85555C2.69516 7.50386 2.29132 9.52109 2.67309 11.4663C3.05487 13.4115 4.19122 15.1264 5.83373 16.2363ZM8.12498 8.75C8.12498 9.08152 7.99329 9.39947 7.75886 9.63389C7.52444 9.86831 7.2065 10 6.87498 10C6.54346 10 6.22552 9.86831 5.9911 9.63389C5.75668 9.39947 5.62498 9.08152 5.62498 8.75C5.62498 8.41848 5.75668 8.10054 5.9911 7.86612C6.22552 7.6317 6.54346 7.5 6.87498 7.5C7.2065 7.5 7.52444 7.6317 7.75886 7.86612C7.99329 8.10054 8.12498 8.41848 8.12498 8.75ZM14.375 8.75C14.375 9.08152 14.2433 9.39947 14.0089 9.63389C13.7744 9.86831 13.4565 10 13.125 10C12.7935 10 12.4755 9.86831 12.2411 9.63389C12.0067 9.39947 11.875 9.08152 11.875 8.75C11.875 8.41848 12.0067 8.10054 12.2411 7.86612C12.4755 7.6317 12.7935 7.5 13.125 7.5C13.4565 7.5 13.7744 7.6317 14.0089 7.86612C14.2433 8.10054 14.375 8.41848 14.375 8.75ZM9.99998 13.75C9.32074 13.7517 8.6538 13.5688 8.07039 13.221C7.48697 12.8731 7.00899 12.3733 6.68748 11.775L5.59998 12.375C6.03767 13.185 6.69048 13.8584 7.48647 14.3209C8.28246 14.7835 9.19072 15.0174 10.1111 14.9967C11.0316 14.976 11.9284 14.7016 12.7028 14.2037C13.4772 13.7058 14.0991 13.0038 14.5 12.175L13.375 11.6375C13.0675 12.271 12.5879 12.8051 11.991 13.1787C11.3941 13.5523 10.7041 13.7503 9.99998 13.75Z"
                fill="#00332C"
              />
            </svg>
            <!-- Text area -->
            <textarea
              name=""
              id=""
              cols="13"
              rows="1"
              class="resize-none h-full focus:outline-none"
              v-model="msg"
              @keyup.enter="addMsg()"
            ></textarea>
          </div>
          <div class="flex items-center gap-x-4">
            <template v-if="writtingMode"
              ><div @click="addMsg()" class="cursor-pointer">
                <svg
                  width="22"
                  height="22"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M20.8297 10.693L1.2242 0.863296C1.14451 0.823452 1.0531 0.814078 0.966385 0.835171C0.767166 0.88439 0.642947 1.08595 0.692166 1.28751L2.71248 9.5422C2.74295 9.66642 2.83435 9.7672 2.95623 9.80705L6.41795 10.9953L2.95857 12.1836C2.8367 12.2258 2.74529 12.3242 2.71717 12.4485L0.692166 20.7149C0.671072 20.8016 0.680447 20.893 0.720291 20.9703C0.811697 21.1555 1.0367 21.2305 1.2242 21.1391L20.8297 11.3656C20.9023 11.3305 20.9609 11.2695 20.9984 11.1992C21.0898 11.0117 21.0148 10.7867 20.8297 10.693ZM3.0031 18.3664L4.18201 13.5477L11.1008 11.1735C11.1547 11.1547 11.1992 11.1125 11.2179 11.0563C11.2508 10.9578 11.1992 10.8524 11.1008 10.8172L4.18201 8.44533L3.00779 3.64533L17.7265 11.0258L3.0031 18.3664V18.3664Z"
                    fill="black"
                  />
                </svg></div
            ></template>
            <template v-else>
              <!-- File -->
              <svg
                width="18"
                height="19"
                viewBox="0 0 18 19"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M16.865 8.71833L9.20666 16.3767C8.26846 17.3149 6.99598 17.8419 5.66916 17.8419C4.34234 17.8419 3.06987 17.3149 2.13166 16.3767C1.19346 15.4385 0.666382 14.166 0.666382 12.8392C0.666382 11.5123 1.19346 10.2399 2.13166 9.30166L9.79 1.64333C10.4155 1.01786 11.2638 0.666473 12.1483 0.666473C13.0329 0.666473 13.8812 1.01786 14.5067 1.64333C15.1321 2.2688 15.4835 3.11711 15.4835 4.00166C15.4835 4.88621 15.1321 5.73452 14.5067 6.35999L6.84 14.0183C6.68515 14.1732 6.50131 14.296 6.29899 14.3798C6.09667 14.4636 5.87982 14.5068 5.66083 14.5068C5.44184 14.5068 5.22499 14.4636 5.02267 14.3798C4.82035 14.296 4.63651 14.1732 4.48166 14.0183C4.32681 13.8635 4.20398 13.6796 4.12017 13.4773C4.03637 13.275 3.99324 13.0582 3.99324 12.8392C3.99324 12.6202 4.03637 12.4033 4.12017 12.201C4.20398 11.9987 4.32681 11.8148 4.48166 11.66L11.5567 4.59333"
                  stroke="#00332C"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              <!-- Photo -->
              <svg
                width="22"
                height="22"
                viewBox="0 0 22 22"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                @click="launchStream"
              >
                <path
                  d="M19.9375 17.875H2.0625C1.88016 17.875 1.7053 17.8026 1.57636 17.6736C1.44743 17.5447 1.375 17.3698 1.375 17.1875V5.5C1.375 5.31766 1.44743 5.1428 1.57636 5.01386C1.7053 4.88493 1.88016 4.8125 2.0625 4.8125H6.50375L7.67938 3.05937C7.74165 2.9648 7.82633 2.88708 7.92588 2.8331C8.02543 2.77913 8.13676 2.75059 8.25 2.75H13.75C13.8632 2.75059 13.9746 2.77913 14.0741 2.8331C14.1737 2.88708 14.2583 2.9648 14.3206 3.05937L15.4963 4.8125H19.9375C20.1198 4.8125 20.2947 4.88493 20.4236 5.01386C20.5526 5.1428 20.625 5.31766 20.625 5.5V17.1875C20.625 17.3698 20.5526 17.5447 20.4236 17.6736C20.2947 17.8026 20.1198 17.875 19.9375 17.875ZM2.75 16.5H19.25V6.1875H15.125C15.0118 6.18691 14.9004 6.15837 14.8009 6.1044C14.7013 6.05042 14.6167 5.9727 14.5544 5.87813L13.3787 4.125H8.62125L7.44562 5.87813C7.38335 5.9727 7.29867 6.05042 7.19912 6.1044C7.09957 6.15837 6.98824 6.18691 6.875 6.1875H2.75V16.5Z"
                  fill="#00332C"
                  fill-opacity="0.95"
                />
                <path
                  d="M11 15.125C10.1842 15.125 9.38663 14.8831 8.70827 14.4298C8.02992 13.9766 7.50121 13.3323 7.189 12.5786C6.87679 11.8248 6.7951 10.9954 6.95426 10.1953C7.11343 9.39508 7.50629 8.66008 8.08319 8.08319C8.66008 7.50629 9.39508 7.11343 10.1953 6.95426C10.9954 6.7951 11.8248 6.87679 12.5786 7.189C13.3323 7.50121 13.9766 8.02992 14.4298 8.70827C14.8831 9.38663 15.125 10.1842 15.125 11C15.125 12.094 14.6904 13.1432 13.9168 13.9168C13.1432 14.6904 12.094 15.125 11 15.125ZM11 8.25C10.4561 8.25 9.92442 8.41129 9.47218 8.71346C9.01995 9.01563 8.66747 9.44513 8.45933 9.94762C8.25119 10.4501 8.19673 11.0031 8.30284 11.5365C8.40895 12.0699 8.67086 12.56 9.05546 12.9445C9.44005 13.3291 9.93006 13.5911 10.4635 13.6972C10.997 13.8033 11.5499 13.7488 12.0524 13.5407C12.5549 13.3325 12.9844 12.9801 13.2865 12.5278C13.5887 12.0756 13.75 11.5439 13.75 11C13.75 10.2707 13.4603 9.57118 12.9445 9.05546C12.4288 8.53973 11.7293 8.25 11 8.25Z"
                  fill="#00332C"
                />
              </svg>
            </template>
          </div>
        </div>
        <!-- Micro -->
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M13.4699 16.575V21.43C13.47 21.514 13.4369 21.5947 13.378 21.6545C13.3191 21.7144 13.2389 21.7487 13.1549 21.75H10.8449C10.7609 21.7487 10.6808 21.7144 10.6219 21.6545C10.563 21.5947 10.5299 21.514 10.5299 21.43V16.575M11.9999 2.25C13.0091 2.25 13.9769 2.65088 14.6905 3.36446C15.4041 4.07803 15.8049 5.04585 15.8049 6.055V10.765C15.8049 11.7741 15.4041 12.742 14.6905 13.4555C13.9769 14.1691 13.0091 14.57 11.9999 14.57V14.57C10.9908 14.57 10.023 14.1691 9.30941 13.4555C8.59583 12.742 8.19495 11.7741 8.19495 10.765V6.055C8.19495 5.04585 8.59583 4.07803 9.30941 3.36446C10.023 2.65088 10.9908 2.25 11.9999 2.25V2.25Z"
            stroke="#00332C"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M6.11499 11.895C6.38552 13.2568 7.11993 14.4826 8.19306 15.3635C9.26619 16.2444 10.6116 16.7259 12 16.7259C13.3884 16.7259 14.7338 16.2444 15.8069 15.3635C16.88 14.4826 17.6145 13.2568 17.885 11.895"
            stroke="#00332C"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
import { ref, computed, onMounted, watch } from "vue";
import BatteryIcon from "./components/BatteryIcon.vue";
import NetworkIcon from "./components/NetworkIcon.vue";
import WifiIcon from "./components/WifiIcon.vue";
import MessagesList from "./components/MessagesList.vue";
import Message from "./components/Message.vue";

import { sendReq } from "./utils";

const battery = ref(1);
const charging = ref(false);

const date = new Date(
  new Date().setDate(new Date().getDate())
).toLocaleDateString("en-US", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});
const hour = ref(new Date().getHours());
const minute = ref(new Date().getMinutes());
const rtt = ref(0);
const type = ref(null);
const msg = ref("");
const writtingMode = ref(false);

const messages = ref();
const { execute, context } = sendReq();

const streaming = ref(false);
let video = document.querySelector("#video");
navigator.getMedia =
  navigator.getUserMedia ||
  navigator.webkitGetUserMedia ||
  navigator.mozGetUserMedia ||
  navigator.msGetUserMedia;
let width = 320;
let height = 0;

//==============Watchers===============
watch(msg, () => {
  if (msg.value.length > 0) {
    writtingMode.value = true;
  } else {
    writtingMode.value = false;
  }
});

onMounted(async () => {
  video = document.querySelector("#video");
  messages.value = [
    {
      msg: "Je suis Séréna, une IA créée par Epoundor pour bavarder avec ses amis facilement. Comment puis-je vous aider aujourd'hui ?",
      mine: false,
      time: parseTime,
    },
  ];

  const t = new Date();
  setInterval(async () => {
    hour.value = new Date().getHours();
    minute.value = new Date().getMinutes();
    rtt.value = navigator.connection.rtt;
    type.value = navigator.connection.effectiveType;
    await navigator.getBattery().then((res: any) => {
      battery.value = res.level;
      charging.value = res.charging;
    });
  }, 500);
});

async function addMsg() {
  const value = msg.value.trim();
  if (value) {
    messages.value.push({
      msg: value,
      mine: true,
      time: parseTime,
    });
    scrollBottom();
    msg.value = "";
    await execute(value);
    context.completion.forEach((el) => {
      messages.value.push({
        msg: el.text,
        mine: false,
        time: parseTime,
      });
      scrollBottom();
    });
  }
}
function launchStream() {
  if (video && !streaming.value) {
    navigator.getMedia(
      {
        video: true,
        audio: true,
      },
      function (stream: Blob | MediaSource) {
        if (navigator.mozGetUserMedia) {
          video!.mozSrcObject = stream;
        } else {
          console.log(stream);
          streaming.value = true;
          video!.srcObject = stream;
        }
        video!.play();
        console.log(stream);
      },
      function (err: string) {
        console.log("An error occured! " + err);
      }
    );
  } else {
    console.log("stream");
  }
}
if (video !== null) {
  video.addEventListener(
    "canplay",
    (ev: any) => {
      console.log("object");
      if (!streaming.value) {
        height = video.videoHeight / (video.videoWidth / width);
        video.setAttribute("width", width);
        video.setAttribute("height", height);
        canvas.setAttribute("width", width);
        canvas.setAttribute("height", height);
      }
    },
    false
  );
}

function scrollBottom() {
  const el = document.querySelector("#msg-list");
  if (el) {
    console.log(el.scrollTop, el.scrollHeight);
    el.scrollTop = el.scrollHeight;
    console.log(el.scrollTop, el.scrollHeight);
    console.log("object");
  }
  console.log(context.completion);
}
const parseTime = computed(() => {
  return (
    hour.value.toString().padStart(2, 0) +
    ":" +
    minute.value.toString().padStart(2, 0)
  );
});
</script>

<style scoped>
.phone {
  box-shadow: 0px 0px 24px rgba(0, 0, 0, 0.25);
}
</style>
